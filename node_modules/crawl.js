
var request = require('request');
var cheerio = require('cheerio');


var mongo = require('mongodb');
var db = require('monk')('localhost/tagslocal');
var products = db.get('products');
var db1 = require('db');










module.exports = {

	crawl_site_snapdeal: function(url,brand){
		global.specs_row_arr = {};
		request(url,function(error,response,html){
			function filter_title(title){
				title = title.replace(/\([\w]*[\s]*[\w]*\)/,"");
				var colors =	['Wine','Red','Green','Cyan','Space','Purple','Ultra','Yellow','Grey','Marble','Champagne','Pure','White','Black','Silver','Gray','metallic','Metallic','Blue','Gold','silver','Mist'];
				for(i=0;i<colors.length;i++){
					title = title.replace(colors[i],"");
					title = title.replace(/\n/,"");
					title = title.trim();

				}
				return title;
			}
		

		if(!error && response.statusCode == 200){
			
		var $ = cheerio.load(html);
		var products = $('#products-main .gridLayout4');

		
		products.each(function(i,element){ 
				global.specs_row_arr = {};
				var href = products.eq(i).find('a').eq(0).attr('href');
				 request(href,function(error,response,html){
				 	var $ = cheerio.load(html);

				 	var title = $('.productTitle .pdpName h1').text();
				 	title = filter_title(title);
				 	var desc = $('.detailssubbox .details-content').text();
				 	var imgsrc = $('#product-slider img').eq(0).attr('src');
				 	var rows = $('table.product-spec tr');
					
				 	rows.each(function(i,element){

							var row_name = rows.eq(i).find('td').eq(0).text();
				
							var value = rows.eq(i).find('td').eq(1).text();
							if(row_name != "")
							global.specs_row_arr[row_name] = value;
							// console.log(global.specs_row_arr[row_name]+"\n");
						});
				 	console.log(title+"\n");

				 	db1.add_product_snapdeal(title,desc,imgsrc,"phones",brand,"",global.specs_row_arr);
				 });

			
			
			
			});
			
			}

			});
		  




	},


	crawl_site_gsmarena: function(url,brand){
			

			global.href_arr = new Array();
			global.src_arr = new Array();
			global.title_arr = new Array();
			global.desc_arr = new Array();
			global.specs_table_arr = {};
			global.specs_row_arr = {};

function find_index(title){
    var found = false;
    var num = "";

	for(var i=0;i<global.title_arr.length;i++){
		    if(found == false){
		if(global.title_arr[i] == title){
			num = i;
			found = true;
		}
		
}
	}
	return num;
}

request(url, function(error,response,html){
			if(!error && response.statusCode == 200){
				var $ = cheerio.load(html);

		
				var products = $('.makers ul li');
		
				products.each(function(i,element){
									
					var href = products.eq(i).find('a').attr('href');
					
					var title = products.eq(i).find('strong').text();
					var desc = products.eq(i).find('img').attr('title');
					//console.log(href + '\n' + src + '\n' + title +'\n' + desc);
					//db1.add_product(title,desc,src,"phone",brand);						
					global.href_arr.push(href);
					global.title_arr.push(brand+" "+title);
					global.desc_arr.push(desc);
					



					

					
				});
				global.href_arr.forEach(function(el,index,err){
								
				request('http://gsmarena.com/'+global.href_arr[index],function(err,response,html){
						//console.log(global.href_arr[index]);
						var $ = cheerio.load(html);
						var src = $('#specs-cp-pic img').attr('src');
						var title1 = $("#main h1",0).text();
						var rows = $("div#specs-list table tr");
						global.specs_row_arr = {};
						rows.each(function(i,element){
							var row_name = rows.eq(i).find('.ttl').text();
						//	row_name = row_name.replace(/[\s.-]/,"");
							var value = rows.eq(i).find('.nfo').text();
							global.specs_row_arr[row_name] = value;
							//console.log(global.specs_row_arr[row_name]);


						});
						//console.log(global.specs_row_arr['SIM']+'\n \n');
						var index = find_index(title1);
					
						console.log(index);
						global.specs_table_arr[index] = global.specs_row_arr;
						global.src_arr[index] = src ;
						//console.log(global.specs_table_arr[index]);
						db1.add_product(global.title_arr[index],global.desc_arr[index],global.src_arr[index],"phones",brand,"",global.specs_table_arr[index]);
					});

				
});	
				
			}
		});








	}


	


}
